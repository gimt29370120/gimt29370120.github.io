<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>改變圖片顏色</title>
  <style>
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    .l80 {
      position:relative;left:80px;
    }
  </style>
</head>
<body>
  <h2 class="l80">上傳圖片並修改 RGB</h2>
  <input type="file" id="upload" class="l80" accept="image/*"/><br/>
  <a class="l80">請輸入公式：</a><br/>
  <a class="l80">R =</a><input type="text" value="r" id="rFactor" style="position:absolute;left:120px;"><br/>
  <a class="l80">G =</a><input type="text" value="g" id="gFactor" style="position:absolute;left:120px;"/><br/>
  <a class="l80">B =</a><input type="text" value="b" id="bFactor" style="position:absolute;left:120px;"/><br/>
  <canvas id="canvas" class="l80"/>

  <script>
    const uploadInput = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    uploadInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // 設定畫布大小與圖片相同
          canvas.width = img.width;
          canvas.height = img.height;

          // 繪製圖片
          ctx.drawImage(img, 0, 0);

          // 取得像素資料
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;

          // 修改每個像素的 RGB 值
          const rInput = document.getElementById("rFactor");
          const gInput = document.getElementById("gFactor");
          const bInput = document.getElementById("bFactor");

          const rFunc = new Function('r', 'g', 'b', 'return ' + rInput.value);
          const gFunc = new Function('r', 'g', 'b', 'return ' + gInput.value);
          const bFunc = new Function('r', 'g', 'b', 'return ' + bInput.value);
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            data[i]     = Math.max(0, Math.min(255, rFunc(r, g, b)));
            data[i + 1] = Math.max(0, Math.min(255, gFunc(r, g, b)));
            data[i + 2] = Math.max(0, Math.min(255, bFunc(r, g, b)));
          }
          // 更新畫布顯示新的圖片資料
          ctx.putImageData(imageData, 0, 0);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>